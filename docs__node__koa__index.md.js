(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[99],{"dr/N":function(e,n,t){"use strict";t.r(n);var a=t("q1tI"),r=t.n(a),c=t("dEAq"),o=t("H1Ra"),l=r.a.memo((e=>{e.demos;return r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"markdown"},r.a.createElement("h2",{id:"koa-\u7684\u4e2d\u95f4\u4ef6\u539f\u7406"},r.a.createElement(c["AnchorLink"],{to:"#koa-\u7684\u4e2d\u95f4\u4ef6\u539f\u7406","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"KOA \u7684\u4e2d\u95f4\u4ef6\u539f\u7406"),r.a.createElement(o["a"],{code:"const middleware = [];\nlet mw1 = async function (ctx, next) {\n  console.log(ctx, 'next\u524d\uff0c\u7b2c\u4e00\u4e2a\u4e2d\u95f4\u4ef6');\n  await next();\n  console.log(ctx, 'next\u540e\uff0c\u7b2c\u4e00\u4e2a\u4e2d\u95f4\u4ef6');\n};\nlet mw2 = async function (ctx, next) {\n  console.log('next\u524d\uff0c\u7b2c\u4e8c\u4e2a\u4e2d\u95f4\u4ef6');\n  await next();\n  console.log('next\u540e\uff0c\u7b2c\u4e8c\u4e2a\u4e2d\u95f4\u4ef6');\n};\nlet mw3 = async function (ctx, next) {\n  console.log('\u7b2c\u4e09\u4e2a\u4e2d\u95f4\u4ef6\uff0c\u6ca1\u6709next\u4e86');\n};\n\nfunction use(mw) {\n  middleware.push(mw);\n}\n\nfunction compose(middleware) {\n  return function (context, next) {\n    return dispatch(0);\n    function dispatch(i) {\n      let fn = middleware[i];\n      if (!fn) return Promise.resolve();\n      try {\n        return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));\n      } catch (e) {\n        return Promise.reject(e);\n      }\n    }\n  };\n}\n\nuse(mw1);\nuse(mw2);\nuse(mw3);\nlet fn = compose(middleware);\nfn();",lang:"js"}),r.a.createElement("h3",{id:"use"},r.a.createElement(c["AnchorLink"],{to:"#use","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"use"),r.a.createElement("p",null,"use \u65b9\u6cd5\u5c31\u662f\u505a\u4e86\u4e00\u4ef6\u4e8b\uff0c\u7ef4\u62a4\u5f97\u5230 middleware \u4e2d\u95f4\u4ef6\u6570\u7ec4"),r.a.createElement(o["a"],{code:"use(fn) {\n  this.middleware.push(fn)\n  return this\n}",lang:"js"}),r.a.createElement("h3",{id:"listen-\u65b9\u6cd5-\u548c-callback-\u65b9\u6cd5"},r.a.createElement(c["AnchorLink"],{to:"#listen-\u65b9\u6cd5-\u548c-callback-\u65b9\u6cd5","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"listen \u65b9\u6cd5 \u548c callback \u65b9\u6cd5"),r.a.createElement("p",null,"\u6267\u884c app.listen \u65b9\u6cd5\u7684\u65f6\u5019\uff0c\u5176\u5b9e\u662f Node.js \u539f\u751f http \u6a21\u5757 createServer \u65b9\u6cd5\u521b\u5efa\u4e86\u4e00\u4e2a\u670d\u52a1\uff0c\u5176\u56de\u8c03\u4e3a callback \u65b9\u6cd5\u3002callback \u65b9\u6cd5\u4e2d\u5c31\u6709\u6211\u4eec\u4eca\u5929\u7684\u91cd\u70b9 compose \u51fd\u6570\uff0c\u5b83\u7684\u8fd4\u56de\u662f\u4e00\u4e2a ",r.a.createElement("strong",null,"Promise")," \u51fd\u6570\u3002"),r.a.createElement(o["a"],{code:"listen(...args) {\n    debug('listen');\n    const server = http.createServer(this.callback());\n    return server.listen(...args);\n  }\n\n  callback() {\n    const fn = compose(this.middleware);\n\n    if (!this.listenerCount('error')) this.on('error', this.onerror);\n\n    const handleRequest = (req, res) => {\n      const ctx = this.createContext(req, res);\n      return this.handleRequest(ctx, fn);\n    };\n\n    return handleRequest;\n  }",lang:"js"}),r.a.createElement("p",null,"handleRequest \u4e2d\u4f1a\u6267\u884c compose \u51fd\u6570\u4e2d\u8fd4\u56de\u7684 Promise \u51fd\u6570\u5e76\u8fd4\u56de\u7ed3\u679c\u3002"),r.a.createElement(o["a"],{code:"handleRequest(ctx, fnMiddleware) {\n    const res = ctx.res;\n    res.statusCode = 404;\n    const onerror = err => ctx.onerror(err);\n    const handleResponse = () => respond(ctx);\n    onFinished(res, onerror);\n     // \u6267\u884c compose \u4e2d\u8fd4\u56de\u7684promise\u51fd\u6570\uff0c\u5c06\u7ed3\u679c\u8fd4\u56de\n    return fnMiddleware(ctx).then(handleResponse).catch(onerror);\n  }",lang:"js"}),r.a.createElement("h2",{id:"\u819c\u62dc\u5927\u4f6c"},r.a.createElement(c["AnchorLink"],{to:"#\u819c\u62dc\u5927\u4f6c","aria-hidden":"true",tabIndex:-1},r.a.createElement("span",{className:"icon icon-link"})),"\u819c\u62dc\u5927\u4f6c"),r.a.createElement("ul",null,r.a.createElement("li",null,r.a.createElement(c["Link"],{to:"https://mp.weixin.qq.com/s/uO-M7VePpBJIUjwHMybfVw"},"\u3010Node\u3011\u6df1\u5165\u6d45\u51fa Koa \u7684\u6d0b\u8471\u6a21\u578b")))))}));n["default"]=e=>{var n=r.a.useContext(c["context"]),t=n.demos;return r.a.useEffect((()=>{var n;null!==e&&void 0!==e&&null!==(n=e.location)&&void 0!==n&&n.hash&&c["AnchorLink"].scrollToAnchor(decodeURIComponent(e.location.hash.slice(1)))}),[]),r.a.createElement(l,{demos:t})}}}]);