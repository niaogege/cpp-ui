---
title: nodejs cluster 集群以及进程线程
order: 1
group:
  title: node
  order: 2
nav:
  order: 5
  title: 'node'
  path: /node
---

问题来源：

- Pm2 中的 cluster 模式和 fork 模式区别
- child_process 模块提供的 4 种新建子进程 API: spawn、execFile、exec 和 fork
- Nodejs 的 Cluster 模块采用了哪种集群模式？
- 多个进程为什么可以监听同一个端口？
- 多个进程之间如何通信？
- 如何对多个 Worker 进行请求分发？（负载均衡策略）
- Node 是怎么部署的? pm2 守护进程的原理?
- Node 开启子进程的方法有哪些?

### 进程

> 进程和线程有点晕

进程（Process）是计算机中的程序关于某数据集合上的一次运行活动，是系统进行资源分配和调度的基本单位，是操作系统结构的基础，进程是线程的容器（来自百科）。我们**启动一个服务、运行一个实例，就是开一个服务进程**，例如 Java 里的 JVM 本身就是一个进程，Node.js 里通过 node app.js 开启一个**服务进程**，多进程就是进程的复制（fork），fork 出来的每个进程都拥有自己的独立空间地址、数据栈，一个进程无法访问另外一个进程里定义的变量、数据结构，只有建立了**IPC** 通信，进程之间才可数据共享。

### 线程

线程是操作系统能够进行运算调度的最小单位，首先我们要清楚线程是隶属于进程的，被包含于进程之中。一个线程只能隶属于一个进程，但是一个进程是可以拥有多个线程的。同一块代码，可以根据系统 CPU 核心数启动多个进程，每个进程都有属于自己的独立运行空间，进程之间是不相互影响的。同一进程中的多条线程将共享该进程中的全部系统资源，如**虚拟地址空间，文件描述符和信号处理**等。但同一进程中的多个线程有各自的调用栈（call stack），自己的寄存器环境（register context），自己的线程本地存储（thread-local storage)，线程又有单线程和多线程之分，具有代表性的 JavaScript、Java 语言。

### 单线程

单线程就是一个进程只开一个线程，想象一下一个痴情的少年，对一个妹子一心一意用情专一。 Javascript 就是属于单线程，程序顺序执行，可以想象一下队列，前面一个执行完之后，后面才可以执行，当你在使用单线程语言编码时切勿有过多耗时的同步操作，否则线程会造成阻塞，导致后续响应无法处理。你如果采用 Javascript 进行编码时候，请尽可能的使用**异步操作**。

```js
// compute.js
const http = require('http');
const [url, port] = ['127.0.0.1', 3000];

const computation = () => {
  let sum = 0;
  console.info('计算开始');
  console.time('计算耗时');

  for (let i = 0; i < 1e10; i++) {
    sum += i;
  }

  console.info('计算结束');
  console.timeEnd('计算耗时');
  return sum;
};

const server = http.createServer((req, res) => {
  if (req.url == '/compute') {
    const sum = computation();

    res.end(`Sum is ${sum}`);
  }

  res.end(`ok`);
});

server.listen(port, url, () => {
  console.log(`server started at http://${url}:${port}`);
});
```

单线程使用总结： Node.js 虽然是单线程模型，但是其基于事件驱动、异步非阻塞模式，可以应用于高并发场景，避免了线程创建、线程之间上下文切换所产生的资源开销。如果你有需要大量计算，CPU 耗时的操作，开发时候要注意。

### 多线程

多线程就是没有一个进程只开一个线程的限制，好比一个风流少年除了爱慕自己班的某个妹子，还在想着隔壁班的漂亮妹子。Java 就是多线程编程语言的一种，可以有效避免代码阻塞导致的后续请求无法处理。

多线程使用总结：

多线程的代价还在于创建新的线程和执行期上下文线程的切换开销，由于每创建一个线程就会占用一定的内存，当应用程序并发大了之后，内存将会很快耗尽。类似于上面单线程模型中例举的例子，需要一定的计算会造成当前线程阻塞的，还是推荐使用多线程来处理

### Nodejs 的线程与进程

Node.js 是 Javascript 在服务端的运行环境，构建在 chrome 的 V8 引擎之上，基于事件驱动、非阻塞 I/O 模型，充分利用操作系统提供的异步 I/O 进行多任务的执行，适合于 I/O 密集型的应用场景，因为异步，程序无需阻塞等待结果返回，而是基于回调通知的机制，原本同步模式等待的时间，则可以用来处理其它任务，在 Web 服务器方面，著名的 Nginx 也是采用此模式（事件驱动），Nginx 采用 C 语言进行编写，主要用来做高性能的 Web 服务器，不适合做业务。Web 业务开发中，如果你有高并发应用场景那么 Node.js 会是你不错的选择。在单核 CPU 系统之上我们采用 单进程 + 单线程 的模式来开发。在多核 CPU 系统之上，可以通过 **child_process.fork** 开启多个进程（Node.js 在 v0.8 版本之后新增了 **Cluster** 来实现多进程架构） ，即 多进程 + 单线程 模式。注意：开启多进程不是为了解决高并发，主要是解决了单进程模式下 Node.js CPU 利用率不足的情况，充分利用多核 CPU 的性能。

### Pm2 中的 cluster 模式和 fork 模式区别

fork 模式，**单实例多进程**，常用于多语言混编，比如 php、python 等，不支持端口复用，需要自己做应用的端口分配和负载均衡的子进程业务代码。缺点就是单服务器实例容易由于异常会导致服务器实例崩溃。

cluster 模式，**多实例多进程**，但是只支持 node，端口可以复用，不需要额外的端口配置，0 代码实现负载均衡。优点就是由于多实例机制，可以保证服务器的容错性，就算出现异常也不会使多个服务器实例同时崩溃。

### 参考

- [Nodejs 进阶：解答 Cluster 模块的几个疑问](https://juejin.cn/post/6844904087771693070)
- [Node.js 进阶之进程与线程](https://juejin.cn/post/6844903869386850312?searchId=202312191842405B1FDFD95FBC6D001FEB)
- [深入了解 Node.js 中的多线程和多进程](https://zhuanlan.zhihu.com/p/573528198?utm_id=0)
