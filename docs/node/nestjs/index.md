---
title: 全栈框架学习nestjs学习
order: 0
group:
  title: nestjs
  order: 5
  path: /node/nestjs
nav:
  order: 5
  title: 'node'
  path: /node
---

发现自己有这么多的缺点和不懂的点，需要主动学习，什么时候才能想五月君大佬，写出这么优雅的代码出来?[五月君大佬图片压缩](https://github.com/qufei1993/compressor)

## 网关系统

### 应用场景

以电商服务为例子来说，一个系统可以拆分成**用户、交易、订单、商品、活动**等多个功能模块，如果全部的功能都维护在一个项目里面，某些可以公用的模块（例如用户、权限等）就没办法共享给其他项目，项目的体积与代码复杂度也会逐步上升，导致后期维护与协同的成本会逐步增加。

最主要的问题是所有功能都放在一个系统里面开发部署，其中任意一个模块出现了问题都可能会导致整个系统雪崩。

对于一个应用的稳定性来说，如果没办法对单一的模块做**熔断、升级、回滚**等操作，线上不可控的概率极大，这也是目前主流采用**微服务架构**最大的原因之一。

但是，当一个系统的微服务模块数量非常多的情况下，也经常会出现以下问题

- 通用性的认证、鉴权、限流等功能会导致每个微服务都存在造轮子的行为；

- 业务复杂度上升之后，存在域名分配的问题，没办法对每个服务都分配一个新的域名，同时每一个新的服务上线，运维重复配置的工作量只多不少

- 太多的域名服务对客户端并不友好，特别是请求层没有做 **BFF** 的话，每一次拆分新的微服务出来都可能会引起前端的改造；

- 并非每个服务都是同一种语言或者框架所开发，前面提到的公共的插件并不能满足所有的服务，这个情况可能在 DevOps 系统中比较常见

为了解决上述的问题，网关系统随之诞生。我们可以通过网关的统一入口来**调度各个微服务功能模块**，使得每个微服务可以关注于自身的业务功能开发。

### 网关系统

网关系统根据**请求类型**可以分为：

- 静态资源网关：处理前端资源数据包括 CSR、SSR 等；
- API 网关： 随着微服务架构（MSA）的普及，通过统一的 API 网关可以**聚合所有零散的微服务资源**，保持统一的出入口，降低多项目的接入成本以及其他项目的使用成本。

从**功能属性**上可以分为：

流量网关：无关业务属性，单纯做安全（黑白名单）、分流（负载均衡）等；

业务网关：用户（认证、鉴权）、服务稳定性（降级、容灾）、业务属性灰度、代理（资源代理、缓存）、统一前置（日志、数据校验）等。

所以，市面上常见的网关系统除了提供请求聚合功能之外基本都包含所有通用功能：

认证（验证登录态，一般不做鉴权）

分流

代理（静态资源、API 等）

AB test （流量灰度，一般根据 IP 或者用户信息灰度）

缓存（成本不低，看看就行）

### Nginx

Nginx 作为专业的 WEB 代理服务器，在代理方面能够提供**负载均衡、流量切换**等功能，脚本语言也有 lua 支持。

### Gateway

业务性的 Gateway 需要做点啥：

- 统一鉴权收口，通过统一配置给接口资源添加权限；

- 支持 RPC 微服务调用，减少资源消耗；

- 系统易于监控，同时可以采集收口进来的信息。

通过两者的对比可以看出，Nginx 更关注**负载均衡以及反向代理**，对业务部分的侵入很低，而 Gateway 作为后端应用，可以携带业务属性，两者可以很好的互补。

在系统架构设计上，我们可以使用 Nginx 作为上文所说的流量网关，由 Nginx 做一层流量代理，通过负载均衡到 Gateway 做业务层的转发处理，这样可以减少我们自建网关系统的工作量。

[网关系统架构](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e15b1e4bc0b842a1affeba55594b232d~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

### 网关系统设计

网关系统架构可以分为两大模块，分别是**代理转发的基础模块**以及独立的**用户模块**。

- 网关基础服务因为流量入口已经有 Nginx 作负载均衡，我们网关的基础服务就可以专注于代理模块的开发：

专注于前后端资源分发以及不同类型的项目 API 分发；常用资源缓存模块； AB Test 模块；通用日志模块。

- 用户模块

用户登录、认证等基础功能；权限系统（基于 RBAC 包括角色、系统、资源等权限控制）。

- 物料系统

物料系统主要是针对于**静态资源**的管理，一般物料系统会跟 DevOps 体系关联比较大，毕竟物料会涉及构建部署的过程，但我们的主题并不是 DevOps，所以物料系统在小册的占比不会很高，只是作为一个辅助类型的项目为网关服务提供静态资源路由的配置、资源版本的管理等功能。
