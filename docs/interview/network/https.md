---
title: HTTPS
order: 3
group:
  order: 2
  title: 网络
  path: /interview/network
nav:
  order: 3
  title: 'interview'
  path: /interview
---

https 背完了忘，过一段时间在记，再忘，不断循环中，不得不佩服大厂的更文水平和深度，[探秘 HTTPS](https://mp.weixin.qq.com/s/mpoDKIsQbNdpuBNhnvvf-g)写得很赞！

## 不知道如何看起

## http 历史轨迹

由 HTTP 的发展历程来看，最开始版本的 HTTP(HTTP1.0)在每次建立 TCP 连接后只能发起一次 HTTP 请求，请求完毕就释放 TCP 连接。我们都知道 TCP 连接的建立需要经过三次握手的过程，而每次发送 HTTP 请求都需要重新建立 TCP 连接，毫无疑问是很低效的。所以 HTTP1.1 改善了这一点，使用长连接的机制，也就是“一次 TCP 连接，N 次 HTTP 请求”。

HTTP 协议的长连接和短连接，实质上是 TCP 协议的**长连接和短连接**。

在使用长连接的情况下，当一个网页打开完成后，客户端和服务器之间用于传输 HTTP 数据的 TCP 连接不会关闭，客户端再次访问这个服务器时，会继续使用这一条已经建立的连接。Keep-Alive 不会永久保持连接，它有一个保持时间，可以在不同的服务器软件（如 Apache）中设定这个时间。实现长连接需要客户端和服务端都支持长连接。

（HTTP1.0 若要开启长连接，需要加上**Connection: keep-alive**请求头）

### HTTP 有以下 3 点安全性问题：

- 身份校验，有可能遭受中间人攻击，我们无法验证通信的另一方就是我们的目标对象。

- 数据保密性问题，敏感信息极易泄露造成安全隐患

- 数据完整性，HTTP 数据包在到达目的主机前会经过很多转发设备，每一个设备节点都可能会篡改或调包信息，无法验证数据的完整性。

## 加密方式

对称算法，非对称算法，数字摘要，前两种适合数据传输加密，而数字摘要**不可逆的特性**常被用于数字签名。

### 对称加密

对称加密也称为密钥加密或单向加密，就是使用同一套密钥来进行加密和解密。密钥可以理解为加密算法

广泛使用的对称加密有： **DES/AES** 优点：算法公开、简单，加密解密容易，加密速度快，效率高。缺点：相对来说不算特别安全，只有一把钥匙，密文如果被拦截，且密钥也被劫持，那么，信息很容易被破译。适用场景：加解密速度快、效率高，因此适用于大量数据的加密场景。由于如何传输密钥是较为头痛的问题，因此适用于无需进行密钥交换的场景，如内部系统，事先就可以直接确定密钥。

> base64 编码也属于对称加密哦

### 非对称加密

非对称加密使用一对密钥(公钥和私钥)进行加密和解密。非对称加密可以在不直接传递密钥的情况下，完成解密，具体步骤如下 👇：

乙方生成两把密钥（公钥和私钥）。公钥是公开的，任何人都可以获得，私钥则是保密的。甲方获取乙方的公钥，然后用它对信息加密。乙方得到加密后的信息，用私钥解密。广泛使用的非对称加密有：**RSA** 1024 位的 RSA 密钥基本安全，2048 位的密钥极其安全

优点：强度高、安全性强于对称加密算法、无需传递私钥导致没有密钥泄露风险缺点：计算量大、速度慢适用场景：适用于需要密钥交换的场景，如互联网应用，无法事先约定密钥。可以与对称加密算法结合：

- 利用非对称加密算法安全性较好的特点来传递对称加密算法的**密钥**。
- 利用对称加密算法**加解密速度快**的特点，进行数据内容比较大的加密场景的加密。如 HTTPS。

### ssl 协议

SSL 协议是位于**应用层和传输层**之间，可以为任何基于 TCP 等可靠连接的应用层协议提供安全性保证，为数据通讯提供安全支持。

SSL 协议的主要功能：

机密性：加密处理，加密数据以防止数据中途被窃取；

完整性：维护数据的完整性，确保数据在传输过程中不被改变；

认证性：认证服务器的真实身份，确保数据发送到正确的客户机和服务器

### SSL/TLS 协议和证书的关系

为保证网络安全，我们需要给服务器颁发证书，这个证书可以自己生成，但是自己颁发证书是不安全的，可以被别人伪造，所以我们一般都是在第三方认证机构购买证书 。那么问题来了，证书到底和协议是否有关联，我们是否需要区分 SSL 证书和 TLS 证书呢？答案是否定的，证书不依赖协议，和协议没有太大关联，我们也不需要去纠结是使用 SSL 证书和 TLS 证书，协议由服务器配置决定，证书是配合协议一块使用的。

## https 请求流程(Tls1.2)

![http2_process.png](https://s2.loli.net/2022/05/05/aUNcYeXOKq4BPp1.png) 本人总结 1.client 向 server 端发送 https 请求，同时把自己支持的 tls 版本 加密套件 和 client-random 给服务端 2.server 端向 client 端打招呼，确认支持的 tls 版本 加密套件，同时也生成自己的 server-random 给 client 3.server 的向 client 发送证书和公钥 4.三个信息都发送完之后告诉客户端 done 5.client 端在此生成一个随机数，也称为预主密钥，用刚刚收到的公钥进行加密，然后在发给 server 6.server 用自己的私钥进行解密，得到预主密钥，然后用 client-random/server-random/预主密钥生成一个会话密钥，同时客户端也用同样的方式生成一模一样的会话密钥。会话密钥生成之前都是采用非对称加密，后续都是采用对称加密 7.Server 使用会话密钥加密“明文内容 A”，发送给 Client。Client 使用会话密钥解密响应的密文，得到“明文内容 A”

他人总结

1. 浏览器生成 client-params、和 client-random、TLS 版本和加密方法列表发送给服务器
2. 服务器返回 server-params、server-random、加密方法、证书、摘要等传给浏览器
3. 浏览器证书校验，通过则继续，返回握手数据摘要等信息传给服务器
4. 浏览器端用 client-random/server-random/pre-random 三个随机数生成最终密钥，
5. 服务端也用 client-random/server-random/pre-random 三个随机数生成最终密钥 完了双方都用了回话密钥
6. 服务端返回的信息用会话密钥加密传给客户端
7. 客户端用之前的会话密钥解密

HTTPS 确实解决了 HTTP 的三个安全性问题：

（1） 保密性：结合非对称加密和对称加密实现保密性。用非对称加密方式加密对称加密的秘钥，再用对称加密方式加密数据

（2） 完整性：通过第三方 CA 的数字签名解决完整性问题

（3） 身份校验：通过第三方 CA 的数字证书验证服务器的身份

## 参考

- [经得住拷问的 HTTPS 原理解析](https://mp.weixin.qq.com/s/RDQvxdkOzzYlaianYk2n5Q)
- [探秘 HTTPS](https://mp.weixin.qq.com/s/mpoDKIsQbNdpuBNhnvvf-g)
- [HTTPS 是什么？加密原理和证书。SSL/TLS 握手过程](https://www.bilibili.com/video/BV1KY411x7Jp?spm_id_from=333.337.search-card.all.click)
