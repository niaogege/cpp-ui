---
title: HTTPS
order: 3
group:
  order: 2
  title: 网络
  path: /interview/network
nav:
  order: 3
  title: 'interview'
  path: /interview
---

https 背完了忘，过一段时间在记，再忘，不断循环中，不得不佩服大厂的更文水平和深度，[探秘 HTTPS](https://mp.weixin.qq.com/s/mpoDKIsQbNdpuBNhnvvf-g)写得很赞！

## 不知道如何看起

## http 历史轨迹

由 HTTP 的发展历程来看，最开始版本的 HTTP(HTTP1.0)在每次建立 TCP 连接后只能发起一次 HTTP 请求，请求完毕就释放 TCP 连接。我们都知道 TCP 连接的建立需要经过三次握手的过程，而每次发送 HTTP 请求都需要重新建立 TCP 连接，毫无疑问是很低效的。所以 HTTP1.1 改善了这一点，使用长连接的机制，也就是“一次 TCP 连接，N 次 HTTP 请求”。

HTTP 协议的长连接和短连接，实质上是 TCP 协议的**长连接和短连接**。

在使用长连接的情况下，当一个网页打开完成后，客户端和服务器之间用于传输 HTTP 数据的 TCP 连接不会关闭，客户端再次访问这个服务器时，会继续使用这一条已经建立的连接。Keep-Alive 不会永久保持连接，它有一个保持时间，可以在不同的服务器软件（如 Apache）中设定这个时间。实现长连接需要客户端和服务端都支持长连接。

（HTTP1.0 若要开启长连接，需要加上**Connection: keep-alive**请求头）

### HTTP 有以下 3 点安全性问题：

- 身份校验，有可能遭受中间人攻击，我们无法验证通信的另一方就是我们的目标对象。

- 数据保密性问题，敏感信息极易泄露造成安全隐患

- 数据完整性，HTTP 数据包在到达目的主机前会经过很多转发设备，每一个设备节点都可能会篡改或调包信息，无法验证数据的完整性。

## 加密方式

对称算法，非对称算法，数字摘要，前两种适合数据传输加密，而数字摘要**不可逆的特性**常被用于生成数字签名。

### 对称加密

对称加密也称为密钥加密或单向加密，就是使用同一套密钥来进行加密和解密。密钥可以理解为加密算法

对称加密是一种**共享密钥**的算法，客户端与服务端共用一把密钥，对数据做加密传输，如果密钥只有通信双方持有，不保证泄漏，那就可以保证安全。

广泛使用的对称加密有： **DES/AES** 优点：算法公开、简单，加密解密容易，加密速度快，效率高。缺点：相对来说不算特别安全，只有一把钥匙，密文如果被拦截，且密钥也被劫持，那么，信息很容易被破译。适用场景：加解密速度快、效率高，因此适用于大量数据的加密场景。由于如何传输共享密钥是较为头痛的问题，因此适用于无需进行密钥交换的场景，如内部系统，事先就可以直接确定密钥。

现实世界中显然不是这样的，例如浏览器同服务器交互，服务器把**共享密钥**传输给浏览器，这个密钥在传输过程中怎么保证不被截取、篡改？

> base64 编码也属于对称加密哦

### 非对称加密

非对称加密使用一对密钥(公钥和私钥)进行加密和解密。非对称加密可以在不直接传递密钥的情况下，完成解密，具体步骤如下 👇：

乙方生成两把密钥（公钥和私钥）。公钥是公开的，任何人都可以获得，私钥则是保密的。甲方获取乙方的公钥，然后用它对信息加密。乙方得到加密后的信息，用私钥解密。广泛使用的非对称加密有：**RSA** 1024 位的 RSA 密钥基本安全，2048 位的密钥极其安全

优点：强度高、安全性强于对称加密算法、无需传递私钥导致没有密钥泄露风险缺点：计算量大、速度慢适用场景：适用于需要密钥交换的场景，如互联网应用，无法事先约定密钥。可以与对称加密算法结合：

- 利用非对称加密算法安全性较好的特点来传递对称加密算法的**密钥**。
- 利用对称加密算法**加解密速度快**的特点，进行数据内容比较大的加密场景的加密。如 HTTPS。

### ssl 协议

SSL 协议是位于**应用层和传输层**之间，可以为任何基于 TCP 等可靠连接的应用层协议提供安全性保证，为数据通讯提供安全支持。

SSL 协议的主要功能：

机密性：加密处理，加密数据以防止数据中途被窃取；

完整性：维护数据的完整性，确保数据在传输过程中不被改变；

认证性：认证服务器的真实身份，确保数据发送到正确的客户机和服务器

### SSL/TLS 协议和证书的关系

为保证网络安全，我们需要给服务器颁发证书，这个证书可以自己生成，但是自己颁发证书是不安全的，可以被别人伪造，所以我们一般都是在第三方认证机构 CA 购买证书 。那么问题来了，证书到底和协议是否有关联，我们是否需要区分 SSL 证书和 TLS 证书呢？答案是否定的，证书不依赖协议，和协议没有太大关联，我们也不需要去纠结是使用 SSL 证书和 TLS 证书，协议由服务器配置决定，证书是配合协议一块使用的。

## https 请求流程(Tls1.2)

![http2_process.png](https://s2.loli.net/2022/05/05/aUNcYeXOKq4BPp1.png) 本人总结 1.client 向 server 端发送 https 请求，同时把自己支持的 tls 版本 加密套件 和 client-random 给服务端 2.server 端向 client 端打招呼，确认支持的 tls 版本 加密套件，同时也生成自己的 server-random 给 client 3.server 向 client 发送证书 4.客户端验证证书 5.三个信息都发送完之后告诉客户端 done 6.client 端在此生成第三个随机数，也称为预主密钥，用证书里的公钥进行加密成随机数，然后在发给 server 7.server 用自己的私钥进行解密，得到预主密钥，然后用 client-random/server-random/预主密钥生成一个会话密钥，同时客户端也用同样的方式生成一模一样的会话密钥。会话密钥生成之前都是采用非对称加密，后续都是采用对称加密 8.Server 使用会话密钥加密“明文内容 A”，发送给 Client。Client 使用会话密钥解密响应的密文，得到“明文内容 A”

他人总结

1. 浏览器生成 client-params、和 client-random、TLS 版本和加密方法列表发送给服务器
2. 服务器返回 server-params、server-random、加密方法、证书、摘要等传给浏览器
3. 浏览器证书校验(得到服务端公钥)，通过则继续，返回握手数据摘要等信息传给服务器
4. 浏览器端用 client-random/server-random/pre-random 三个随机数生成最终密钥，
5. 服务端也用 client-random/server-random/pre-random 三个随机数生成最终密钥 完了双方都用了会话密钥(即对称密钥)
6. 服务端返回的信息用**会话密钥**加密传给客户端
7. 客户端用之前的会话密钥解密

HTTPS 确实解决了 HTTP 的三个安全性问题：

（1） 保密性：结合非对称加密和对称加密实现保密性。用非对称加密方式加密对称加密的秘钥，再用对称加密方式加密数据

（2） 完整性：通过第三方 CA 的数字签名解决完整性问题

（3） 身份校验：通过第三方 CA 的数字证书验证服务器的身份

## 计算会话密钥（共享密钥）

上面浏览器向服务器发起请求，服务器返回证书，这个过程双方会交换两个参数，分别是客户端的随机数、服务端的随机数，用于生成主密钥，但是主密钥的生成还依赖一个**预主密钥**。

不同的密钥交换算法，生成预主密钥的方法也不同。一种密钥交换算法是 **RSA**，它的密钥交换过程很简单，由客户端生成预主密钥，为 46 字节的随机数，使用服务器的公钥加密，经过**密钥交换**消息发送到服务端，服务端再用私钥就可解密出这个预主密钥。

基于 RSA 的密钥交换算法被认为存在严重的漏洞威胁，任何能够接触到私钥的人（例如，由于政治、贿赂、强行进入等）都可恢复预主密钥，进而构建相同的主密钥，最终密钥泄漏就可解密之前记录的所有流量了。这种密钥交换算法已经被其它算法替代，例如，ECDHE 算法在密钥交换时，每个链接使用的**主密钥**相互独立，如果出现问题也只是影响到当前会话，不能用于追溯解密任何其它的流量。

**ECDHE**是临时椭圆曲线密钥交换算法，客户端和服务器会分别交换两个信息 Server Params、Client Params，在每次的链接中，都会生成一对新的临时公私钥。基于 ECDHE 算法客户端和服务端可分别计算出预主密钥（premaster secret）

这时客户端和服务端就分别拥有 Client Random、Server Random、Pre master Secret 三个随机数。

最终的会话密钥使用 **PRF** 伪随机函数传入主密钥、客户端随机数、服务端随机数生成。这样客户端和服务端都有了会话密钥，然后通过会话密钥加密来交换数据

## TLS v1.2 协议完整握手过程

我们可以看出 https 先是利用数字证书保证服务器端的**公匙**可以安全无误的到达客户端。然后再用非对称加密安全的传递**共享密匙**，最后用共享密匙安全的交换数据。

再次梳理一遍 https 完整握手过程 20220529

分为四个大阶段

### First： TCP 三次握手

TCP 三次握手，其实就是建立一个 TCP 连接，客户端与服务器交互需要 3 个数据包。握手的主要作用就是为了确认双方的接收和发送能力是否正常，初始序列号，交换窗口大小等信息。

第一次： SYN 客户端向服务器端发送一个 SYN 请求包，包含客户端使用的端口号和初始序列号 seq=x,并进入 **SYN_SENT** 状态，等待服务器的确认

第二次： SYN+ACK 服务器端收到客户端发送过来的 SYN 请求包后，知道客户端想要建立连接，需要向客户端发送一个 SYN+ACK 报文，包含确认号 ack=x+1 和服务器端的初始序列号 seq=y，此时服务器进入 **SYN_RCVD** 状态；

第三次： ACK 客户端收到服务器端返回的 SYN 请求包和 ACK 回应包后，需要向服务器端发送确认包(确认号 ack=y+1 和序号 seq=x+1 的 ACK 请求包)，客户端进入 **ESTABLISHED** 状态。待服务器收到客户端发送的 ACK 包也会进入 ESTABLISHED 状态，完成三次握手。

### Second 交换参数 验证证书

- client 向 server 发送客户端随机数/支持的 TLS 版本/加密套件
- 服务端接受 client 信息，返回服务端随机数/确认支持的 tls 版本 加密套件
- 服务端返回证书给 client
- 服务端返回密钥交换算法 ECDHE 等密钥协商参数信息
- 服务端消息发送完毕
- 客户端验证证书

### Third 计算密钥和验证密钥

### 用最终的会话密钥加密报文，双方通信开始

## HTTPS 及其背后的加密原理

[HTTPS 及其背后的加密原理](./HTTPS%E5%8F%8A%E5%85%B6%E8%83%8C%E5%90%8E%E7%9A%84%E5%8A%A0%E5%AF%86%E5%8E%9F%E7%90%86.md)

## 参考

- [经得住拷问的 HTTPS 原理解析](https://mp.weixin.qq.com/s/RDQvxdkOzzYlaianYk2n5Q)
- [探秘 HTTPS](https://mp.weixin.qq.com/s/mpoDKIsQbNdpuBNhnvvf-g)
- [HTTPS 是什么？加密原理和证书。SSL/TLS 握手过程](https://www.bilibili.com/video/BV1KY411x7Jp?spm_id_from=333.337.search-card.all.click) 看了这么多 https 相关的文章，以下两篇文章说的很通透,非常值得推荐阅读，仔细品味
- [一篇文章读懂 HTTPS 及其背后的加密原理](https://mp.weixin.qq.com/s/3gI8avaaaEaBJjOKitN7Fw)
- [看了很多 HTTPS 原理介绍，这个是最详细的了！](https://mp.weixin.qq.com/s/Kl0D0EorDfqQi2w-tqcVbQ)
