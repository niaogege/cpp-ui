(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[142],{gnH6:function(e,n,t){"use strict";t.r(n);var r=t("q1tI"),l=t.n(r),i=t("dEAq"),o=t("H1Ra"),c=l.a.memo((e=>{e.demos;return l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:"markdown"},l.a.createElement("blockquote",null,l.a.createElement("p",null,"\u5185\u5bb9\u6765\u81ea\u795e\u5149",l.a.createElement(i["Link"],{to:"https://mp.weixin.qq.com/s/sy5ZoXu09_bwhDUb1TcLvw"},"\u624b\u5199\u7b80\u6613\u7248 React \u6765\u5f7b\u5e95\u641e\u61c2 fiber \u67b6\u6784"))),l.a.createElement("blockquote",null,l.a.createElement("p",null,"\u4e86\u89e3 fiber \u8bbe\u8ba1\u7406\u5ff5")),l.a.createElement("p",null,"\u5173\u4e8e Vdom \u4ee5\u53ca class component \u4ee5\u53ca function component \u7ec6\u8282\u79fb\u6b65\u4e0a\u6587"),l.a.createElement("p",null,"createElement \u88ab\u79f0\u4e3a render function\uff0c\u5b83\u7684\u6267\u884c\u7ed3\u679c\u662f vdom\u3002\u4e3a\u4ec0\u4e48\u4e0d\u76f4\u63a5\u628a jsx \u7f16\u8bd1\u4e3a vdom \u5462\uff1f\u56e0\u4e3a ",l.a.createElement("strong",null,"render function")," \u53ef\u4ee5\u6267\u884c\u52a8\u6001\u903b\u8f91\u3002\u6211\u4eec\u53ef\u4ee5\u52a0\u5165 state\u3001props\uff0c\u53ef\u4ee5\u5305\u88c5\u4e00\u4e0b\u5b9e\u73b0 class \u548c function \u7ec4\u4ef6"),l.a.createElement("h2",{id:"v16-\u4e4b\u524d"},l.a.createElement(i["AnchorLink"],{to:"#v16-\u4e4b\u524d","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"V16 \u4e4b\u524d"),l.a.createElement("p",null,"\u5b9e\u73b0 createElement(type, props, ...children)"),l.a.createElement(o["a"],{code:"function createElement(type, props, ...children) {\n  return {\n    type,\n    props: {\n      ...props,\n      children: children.map((child) => {\n        return typeof child === 'object' ? child : createTextElement(child);\n      }),\n    },\n  };\n}\nfunction createTextElement(text) {\n  return {\n    type: 'TEXT_ELEMENT',\n    props: {\n      nodeValue: text,\n      children: [],\n    },\n  };\n}",lang:"js"}),l.a.createElement("h2",{id:"v16-\u4e4b\u540e\u67b6\u6784"},l.a.createElement(i["AnchorLink"],{to:"#v16-\u4e4b\u540e\u67b6\u6784","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"V16 \u4e4b\u540e\u67b6\u6784"),l.a.createElement("p",null,"\u5f15\u5165\u4e86 Fiber \u67b6\u6784\uff0c\u6267\u884c render Function \u4e4b\u540e\u4e0d\u662f\u76f4\u63a5\u6e32\u67d3 vdom\uff0c\u800c\u662f\u5148\u8f6c\u6210 Fiber \u94fe\u8868"),l.a.createElement("p",null,"vdom \u91cc\u901a\u8fc7 ",l.a.createElement("strong",null,"children")," \u5173\u8054\u7236\u5b50\u8282\u70b9\uff0c\u800c fiber \u91cc\u9762\u5219\u662f\u901a\u8fc7 ",l.a.createElement("strong",null,"child")," \u5173\u8054\u7b2c\u4e00\u4e2a\u5b50\u8282\u70b9\uff0c\u7136\u540e\u901a\u8fc7 ",l.a.createElement("strong",null,"sibling")," \u4e32\u8054\u8d77\u4e0b\u4e00\u4e2a\uff0c\u6240\u6709\u7684\u8282\u70b9\u53ef\u4ee5 return \u5230\u7236\u8282\u70b9\u3002"),l.a.createElement("ul",null,l.a.createElement("li",null,"child \u6307\u5411\u5173\u8054\u7684",l.a.createElement("strong",null,"\u7b2c\u4e00\u4e2a"),"\u5b50\u8282\u70b9"),l.a.createElement("li",null,"sibling \u6307\u5411\u540c\u7ea7\u5144\u5f1f\u8282\u70b9"),l.a.createElement("li",null,"return \u6307\u5411\u7236\u7ea7\u8282\u70b9")),l.a.createElement("blockquote",null,l.a.createElement("p",null,"\u94fe\u8868\u7ed3\u6784\uff0c\u5373\u901a\u8fc7 child \u6307\u5411\u4e0b\u4e00\u7ea7\uff0c\u540c\u65f6 sibling \u6307\u5411\u5144\u5f1f\u8282\u70b9\uff0c\u6b64 fiber \u8fd8\u662f\u53cc\u5411\u94fe\u8868\uff0c\u9614\u4ee5\u901a\u8fc7 return \u8282\u70b9\u6307\u56de\u7236\u8282\u70b9")),l.a.createElement("p",null,"schedule: ",l.a.createElement("strong",null,"\u7a7a\u95f2\u65f6"),"\u534f\u8c03\u540e\u9762\u7684 fiber\uff0c\u7531 scheduler \u8c03\u5ea6\u5668\u5b8c\u6210 reconcile: ",l.a.createElement("strong",null,"\u628a vdom \u8f6c Fiber"),", \u7531 reconciler \u534f\u8c03\u5668\u5b8c\u6210 commit: \u6700\u540e\u5168\u90e8\u8f6c\u5b8c\u4e4b\u540e\uff0c\u518d",l.a.createElement("strong",null,"\u4e00\u6b21\u6027 render"),"\uff0c\u7531 renderer \u6e32\u67d3\u5668\u5b8c\u6210"),l.a.createElement("h2",{id:"\u7b80\u5355\u5b9e\u73b0-fiber-\u7248-react"},l.a.createElement(i["AnchorLink"],{to:"#\u7b80\u5355\u5b9e\u73b0-fiber-\u7248-react","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"\u7b80\u5355\u5b9e\u73b0 fiber \u7248 react"),l.a.createElement("h3",{id:"schedule"},l.a.createElement(i["AnchorLink"],{to:"#schedule","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"schedule"),l.a.createElement("p",null,"\u5faa\u73af\u8c03\u5ea6\u6d4f\u89c8\u5668\u662f\u5426\u8fd8\u6709\u7a7a\u95f2\u65f6\u95f4\uff0c\u5982\u679c\u6709\u7a7a\u95f2\u65f6\u95f4\u5c31\u53bb\u534f\u8c03 vdom \u8f6c\u6210 fiber,\u76f4\u5230\u6240\u6709 vdom \u8282\u70b9\u90fd\u8f6c\u6210\u4e86 fiber,\u5c31\u5f00\u59cb\u8fdb\u884c commit \u64cd\u4f5c"),l.a.createElement(o["a"],{code:"let nextFiberReconcileWork = null; // \u5f53\u524d\u5904\u7406\u5230\u7684fiber\nlet wipRoot = null; // \u6839\u8282\u70b9\n\nrequestIdleCallback(workLoop);\n\nfunction workLoop(deadline) {\n  let shouldYield = false;\n  while (nextFiberReconcileWork && !shouldYield) {\n    // reconcile\n    nextFiberReconcileWork = performNextWork(nextFiberReconcileWork);\n    console.log(nextFiberReconcileWork, 'nextFiberReconcileWork');\n    shouldYield = deadline.timeRemaining() < 1;\n  }\n  if (!nextFiberReconcileWork && wipRoot) {\n    commitRoot(); // commit\n  }\n  requestIdleCallback(workLoop);\n}\n\n// reconcile\u5f53\u524d\u7684fiber\n// \u6309\u7167\u987a\u5e8f\u5904\u7406child/sibling\n// reconcile \u5f53\u524d fiber \u8282\u70b9\uff0c\u7136\u540e\u518d\u6309\u7167\u987a\u5e8f\u7ee7\u7eed\u5904\u7406 child\u3001sibling\uff0c\u5904\u7406\u5b8c\u4e4b\u540e\u56de\u5230 return \u7684 fiber \u8282\u70b9\u3002\nfunction performNextWork(fiber) {\n  reconcile(fiber);\n  if (fiber.child) {\n    return fiber.child;\n  }\n  // \u4e0d\u65ad\u8c03\u5ea6\n  let nextFiber = fiber;\n  while (nextFiber) {\n    if (nextFiber.sibling) {\n      return nextFiber.sibling;\n    }\n    nextFiber = nextFiber.return;\n  }\n}",lang:"js"}),l.a.createElement("h3",{id:"reconcile"},l.a.createElement(i["AnchorLink"],{to:"#reconcile","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"reconcile"),l.a.createElement("p",null,"schedule \u7684 loop \u5df2\u7ecf\u5728\u4e0d\u65ad\u8fdb\u884c\u4e86\uff0c\u90a3\u4e48\u53ea\u8981\u63d0\u4ea4\u4e00\u4e2a ",l.a.createElement("strong",null,"nextFiberReconcileWork"),"\uff0c\u4e0b\u6b21 loop \u5c31\u80fd\u5904\u7406\u5230,\u8fd9\u5c31\u662f render \u7684\u5b9e\u73b0"),l.a.createElement("p",null,"reconcile \u4e3b\u8981\u505a\u7684\u5de5\u4f5c\uff1a 1.vdom \u8f6c\u6210 fiber \u683c\u5f0f\uff0c\u6700\u7ec8\u628a vdom \u6811\u8f6c\u6210 fiber \u94fe\u8868 2.\u51c6\u5907\u597d\u8981\u7528\u7684 dom \u8282\u70b9\uff0c\u786e\u5b9a\u662f\u589e\u5220\u6539"),l.a.createElement(o["a"],{code:"// reconcile \u662f vdom \u8f6c fiber\n// \u4e00\u4e2a\u662f\u63d0\u524d\u521b\u5efa\u5bf9\u5e94\u7684 dom \u8282\u70b9\n// diff\uff0c\u786e\u5b9a\u662f\u589e\u3001\u5220\u8fd8\u662f\u6539\nfunction reconcile(fiber) {\n  if (!fiber.dom) {\n    fiber.dom = createDom(fiber);\n  }\n  reconcileChildren(fiber, fiber.props.children);\n}\n\n// \u628a\u4e4b\u524d\u7684vdom\u8f6c\u6210child/sibling/return\u7ec4\u6210\u7684\u94fe\u8868\nfunction reconcileChildren(wipFiber, elements) {\n  let index = 0;\n  let prevSibling = null;\n  while (index < elements.length) {\n    const element = elements[index];\n    // fiber\u683c\u5f0f\n    let newFiber = {\n      type: element.type,\n      props: element.props,\n      dom: null,\n      return: wipFiber,\n      effectTag: 'PLACEMENT', // \u65b0\u589e\u8282\u70b9\u6807\u8bb0\n    };\n    if (index === 0) {\n      wipFiber.child = newFiber;\n    } else if (element) {\n      prevSibling.sibling = newFiber;\n    }\n    prevSibling = newFiber;\n    index++;\n  }\n}\n\nfunction createDom(fiber) {\n  let dom;\n  if (fiber.type === 'PLACEMENT') {\n    dom = document.createTextNode('');\n  } else {\n    dom = document.createElement(fiber.type);\n  }\n  for (const prop in fiber.props) {\n    setAttribute(dom, prop, fiber.props[prop]);\n  }\n  return dom;\n}\n\nfunction createElement(type, props, ...children) {\n  return {\n    type,\n    props: {\n      ...props,\n      children: children.map((child) =>\n        typeof child === 'object' ? child : createTextElement(child),\n      ),\n    },\n  };\n}\n\nfunction createTextElement(text) {\n  return {\n    type: 'TEXT_ELEMENT',\n    props: {\n      nodeValue: text,\n      children: [],\n    },\n  };\n}\n\nfunction render(element, container) {\n  wipRoot = {\n    dom: container,\n    props: {\n      children: [element],\n    },\n  };\n  console.log('render');\n  nextFiberReconcileWork = wipRoot;\n}\n\nconst setAttribute = (dom, key, value) => {\n  if (key === 'children') {\n    return;\n  }\n  if (key === 'nodeValue') {\n    dom.textContent = value;\n  } else if (isEventListenerAttr(key, value)) {\n    const eventType = key.slice(2).toLowerCase();\n    dom.addEventListener(eventType, value);\n  } else if (isStyleAttr(key, value)) {\n    Object.assign(dom.style, value);\n  } else if (isPlainAttr(key, value)) {\n    dom.setAttribute(key, value);\n  }\n};\n\nfunction isEventListenerAttr(key, value) {\n  return typeof value == 'function' && key.startsWith('on');\n}\n\nfunction isStyleAttr(key, value) {\n  return key === 'style' && typeof value == 'object';\n}\n\nfunction isPlainAttr(key, value) {\n  return typeof value != 'object' && typeof value != 'function';\n}",lang:"js"}),l.a.createElement("h3",{id:"commit"},l.a.createElement(i["AnchorLink"],{to:"#commit","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"commit"),l.a.createElement("p",null,"commit \u5c31\u662f\u5bf9 dom \u7684\u589e\u5220\u6539\uff0c\u800c\u4e14\u6bd4\u4e4b\u524d vdom \u67b6\u6784\u65f6\u7684\u6e32\u67d3\u8fd8\u8981\u5feb\uff0c\u56e0\u4e3a dom \u90fd\u63d0\u524d\u521b\u5efa\u4e86"),l.a.createElement("p",null,"\u6bcf\u4e2a fiber \u8282\u70b9\u7684\u6e32\u67d3\u5c31\u662f\u6309\u7167 child\u3001sibling \u7684\u987a\u5e8f\u4ee5\u6b64\u63d2\u5165\u5230 dom \u4e2d"),l.a.createElement(o["a"],{code:"// commit\nfunction commitRoot() {\n  commitWork(wipRoot.child);\n  wipRoot = null;\n}\n\nfunction commitWork(fiber) {\n  if (!fiber) {\n    return;\n  }\n  let domParentFiber = fiber.return;\n  while (!domParentFiber.dom) {\n    domParentFiber = domParentFiber.return;\n  }\n  let domParent = domParentFiber.dom;\n  if (fiber.effectTag === 'PLACEMENT' && fiber.dom !== null) {\n    domParent.appendChild(fiber.dom);\n  }\n  commitWork(fiber.child);\n  commitWork(fiber.sibling);\n}",lang:"js"})))}));n["default"]=e=>{var n=l.a.useContext(i["context"]),t=n.demos;return l.a.useEffect((()=>{var n;null!==e&&void 0!==e&&null!==(n=e.location)&&void 0!==n&&n.hash&&i["AnchorLink"].scrollToAnchor(decodeURIComponent(e.location.hash.slice(1)))}),[]),l.a.createElement(c,{demos:t})}}}]);